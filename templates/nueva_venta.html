{% extends "base.html" %}

{% block content %}
<div class="container-fluid p-3">
    <div class="row h-100">
        
        <div class="col-md-7 d-flex flex-column">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-box-seam"></i> Cat√°logo de Productos</h5>
                </div>
                
                <div class="card-body d-flex flex-column p-2">
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" id="buscador" class="form-control border-start-0 ps-0" 
                               placeholder="Escribe c√≥digo o nombre para buscar..." 
                               onkeyup="filtrarProductos()" autocomplete="off">
                    </div>

                    <div class="table-responsive flex-grow-1" style="max-height: 550px; overflow-y: auto;">
                        <table class="table table-hover align-middle table-sm" id="tablaProductos">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 20%">C√≥digo</th>
                                    <th style="width: 45%">Descripci√≥n</th>
                                    <th style="width: 15%" class="text-center">Stock</th>
                                    <th style="width: 20%" class="text-end">Precio</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in productos %}
                                <tr>
                                    <td class="fw-bold text-primary small">{{ p.codigo }}</td>
                                    <td class="small text-truncate" style="max-width: 200px;" title="{{ p.descripcion }}">
                                        {{ p.descripcion }}
                                    </td>
                                    <td class="text-center">
                                        {% if p.cantidad_actual > 0 %}
                                            <span class="badge bg-success rounded-pill">{{ p.cantidad_actual }}</span>
                                        {% else %}
                                            <span class="badge bg-danger rounded-pill">0</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end fw-bold text-dark">
                                        ${{ "{:,.2f}".format(p.precio_mxn or 0) }}
                                    </td>
                                    <td class="text-end">
                                        {% if p.cantidad_actual > 0 %}
                                        <button class="btn btn-sm btn-outline-primary py-0" 
                                                onclick="agregarDirecto({{ p.id }}, '{{ p.codigo }}', '{{ p.descripcion }}', {{ p.precio_mxn or 0 }}, {{ p.cantidad_actual }})">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-secondary py-0" disabled>-</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div id="no-results" class="text-center mt-4 d-none">
                            <p class="text-muted">No se encontraron productos.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card shadow border-0 h-100">
                <div class="card-header bg-success text-white d-flex justify-content-between">
                    <h5 class="mb-0"><i class="bi bi-cart4"></i> Venta Actual</h5>
                    <button onclick="limpiar()" class="btn btn-sm btn-outline-light border-0" title="Vaciar Carrito">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                
                <div class="card-body d-flex flex-column p-0">
                    
                    <div class="table-responsive flex-grow-1 p-2" style="max-height: 350px; overflow-y: auto;">
                        <table class="table table-sm align-middle mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Desc.</th>
                                    <th class="text-center">Cant.</th>
                                    <th>Precio</th>
                                    <th class="text-end">Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tabla-carrito">
                                </tbody>
                        </table>
                    </div>

                    <div class="bg-light p-3 border-top mt-auto">
                        
                        <div class="mb-2">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white"><i class="bi bi-person"></i></span>
                                <select id="cliente" class="form-select">
                                    {% for c in clientes %}
                                        <option value="{{ c.id }}" data-direccion="{{ c.direccion }}">{{ c.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <select id="tipo_entrega" class="form-select form-select-sm">
                                    <option value="Presencial">üè™ Mostrador</option>
                                    <option value="Paqueteria">üöö Env√≠o</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <select id="metodo_pago" class="form-select form-select-sm border-success fw-bold text-success">
                                    <option value="Efectivo">üíµ Efectivo</option>
                                    <option value="Tarjeta">üí≥ Tarjeta</option>
                                    <option value="Transferencia">üè¶ Transf.</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-2 d-none" id="div_direccion">
                            <textarea id="direccion_envio" class="form-control form-control-sm" rows="1" placeholder="Direcci√≥n de env√≠o..."></textarea>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="h5 text-muted mb-0">Total:</span>
                            <span class="h2 text-success fw-bold mb-0" id="total-texto">$0.00</span>
                        </div>

                        <button onclick="registrarVenta()" class="btn btn-success w-100 py-2 fw-bold shadow">
                            <i class="bi bi-check-lg"></i> TERMINAR VENTA
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let carrito = [];

    // --- 1. FILTRADO R√ÅPIDO DE LA TABLA ---
    function filtrarProductos() {
        let input = document.getElementById("buscador").value.toUpperCase();
        let table = document.getElementById("tablaProductos");
        let tr = table.getElementsByTagName("tr");
        let hayResultados = false;

        // Comenzamos desde 1 para saltar el encabezado
        for (let i = 1; i < tr.length; i++) {
            let tdCodigo = tr[i].getElementsByTagName("td")[0];
            let tdDesc = tr[i].getElementsByTagName("td")[1];
            
            if (tdCodigo && tdDesc) {
                let txtCodigo = tdCodigo.textContent || tdCodigo.innerText;
                let txtDesc = tdDesc.textContent || tdDesc.innerText;
                
                // Buscamos coincidencia
                if (txtCodigo.toUpperCase().indexOf(input) > -1 || txtDesc.toUpperCase().indexOf(input) > -1) {
                    tr[i].style.display = "";
                    hayResultados = true;
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
        
        // Mostrar mensaje si no hay nada
        document.getElementById('no-results').classList.toggle('d-none', hayResultados);
    }

    // --- 2. AGREGAR AL CARRITO DESDE LA TABLA ---
    function agregarDirecto(id, codigo, descripcion, precio, stockMax) {
        let existente = carrito.find(i => i.id === id);

        if (existente) {
            if (existente.cantidad < stockMax) {
                existente.cantidad++;
                existente.subtotal = existente.cantidad * existente.precio;
            } else {
                Swal.fire({toast: true, position: 'top-end', icon: 'warning', title: 'Stock m√°ximo alcanzado', timer: 1500, showConfirmButton: false});
                return;
            }
        } else {
            carrito.push({
                id: id,
                codigo: codigo,
                descripcion: descripcion,
                cantidad: 1,
                precio: precio, // Puede ser 0
                subtotal: precio,
                stockMax: stockMax
            });
        }
        actualizarCarritoUI();
    }

    // --- 3. ACTUALIZAR LA VISTA DEL CARRITO (CON PRECIO EDITABLE) ---
    function actualizarCarritoUI() {
        let tbody = document.getElementById('tabla-carrito');
        tbody.innerHTML = '';
        let totalGlobal = 0;

        carrito.forEach((item, index) => {
            totalGlobal += item.subtotal;
            
            // Si el precio es 0, coloreamos el borde de amarillo
            let alertaClase = item.precio === 0 ? 'border-warning bg-warning bg-opacity-10' : '';

            let row = `
                <tr>
                    <td class="small lh-1" style="max-width: 120px;">
                        <span class="fw-bold text-primary" style="font-size: 0.8rem;">${item.codigo}</span><br>
                        <span class="text-muted text-truncate d-block" style="font-size: 0.75rem;">${item.descripcion}</span>
                    </td>
                    
                    <td style="width: 60px;">
                        <input type="number" min="1" max="${item.stockMax}" 
                               class="form-control form-control-sm text-center px-1" 
                               value="${item.cantidad}" onchange="cambiarCantidad(${index}, this.value)">
                    </td>

                    <td style="width: 85px;">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text px-1 text-muted">$</span>
                            <input type="number" step="0.01" min="0" 
                                   class="form-control px-1 text-end fw-bold ${alertaClase}" 
                                   value="${item.precio}" 
                                   onchange="cambiarPrecio(${index}, this.value)"
                                   title="Editar precio">
                        </div>
                    </td>

                    <td class="text-end fw-bold small" style="width: 70px;">
                        $${item.subtotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </td>

                    <td class="text-end" style="width: 25px;">
                        <i class="bi bi-x text-danger cursor-pointer" onclick="eliminar(${index})" style="cursor: pointer;"></i>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        document.getElementById('total-texto').innerText = '$' + totalGlobal.toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById('total-texto').dataset.valor = totalGlobal;
    }

    // --- 4. FUNCIONES AUXILIARES ---
    function cambiarCantidad(index, cant) {
        let val = parseInt(cant);
        if (val > 0 && val <= carrito[index].stockMax) {
            carrito[index].cantidad = val;
            carrito[index].subtotal = val * carrito[index].precio;
            actualizarCarritoUI();
        } else {
            actualizarCarritoUI(); // Revertir
        }
    }

    function cambiarPrecio(index, precio) {
        let val = parseFloat(precio);
        if (val >= 0) {
            carrito[index].precio = val;
            carrito[index].subtotal = carrito[index].cantidad * val;
            actualizarCarritoUI();
        }
    }

    function eliminar(index) {
        carrito.splice(index, 1);
        actualizarCarritoUI();
    }

    function limpiar() {
        carrito = [];
        actualizarCarritoUI();
    }

    // Control de Env√≠o
    document.getElementById('tipo_entrega').addEventListener('change', function() {
        let div = document.getElementById('div_direccion');
        if(this.value === 'Paqueteria') div.classList.remove('d-none');
        else div.classList.add('d-none');
    });

    // --- 5. TERMINAR VENTA ---
    function registrarVenta() {
        if (carrito.length === 0) {
            Swal.fire('Carrito vac√≠o', '', 'warning');
            return;
        }

        let total = parseFloat(document.getElementById('total-texto').dataset.valor);
        let datos = {
            cliente_id: document.getElementById('cliente').value,
            tipo_entrega: document.getElementById('tipo_entrega').value,
            direccion_envio: document.getElementById('direccion_envio').value,
            metodo_pago: document.getElementById('metodo_pago').value, // <--- ENVIAMOS M√âTODO
            total: total,
            productos: carrito
        };

        // Confirmaci√≥n si el total es 0
        if (total === 0) {
            Swal.fire('¬øCobrar $0.00?', 'Verifica los precios antes de continuar', 'question').then((r) => {
                if(r.isConfirmed) enviarDatos(datos);
            });
        } else {
            enviarDatos(datos);
        }
    }

    function enviarDatos(datos) {
        Swal.showLoading();
        fetch('/nueva-venta', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(datos)
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    title: '¬°Venta Registrada!',
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonText: 'üñ®Ô∏è Imprimir Nota',
                    cancelButtonText: 'Nueva Venta'
                }).then((res) => {
                    if (res.isConfirmed) window.open("/nota_remision/" + data.venta_id, "_blank");
                    window.location.reload();
                });
            } else {
                Swal.fire('Error', 'Algo sali√≥ mal', 'error');
            }
        });
    }
</script>
{% endblock %}